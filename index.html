<!DOCTYPE html>
<html>

  <head>
    <meta charset="UTF-8" />
    <title>What-are-you-doing by WebDesignerKits</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script data-require="jquery@*" data-semver="3.0.0" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0/jquery.js"></script>
    <script data-require="moment.js@*" data-semver="2.14.1" src="https://npmcdn.com/moment@2.14.1"></script>
     <!-- Compiled and minified CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/css/materialize.min.css">

  <!-- Compiled and minified JavaScript -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/js/materialize.min.js"></script>
          
    <link rel="stylesheet" type="text/css" href="https://webdesignerkits.github.io/what-are-you-doing/stylesheets/normalize.css" media="screen" />
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" type="text/css" href="https://webdesignerkits.github.io/what-are-you-doing/stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="https://webdesignerkits.github.io/what-are-you-doing/stylesheets/github-light.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/>
    
    <style>
    #description:focus{
      outline:none;
    }
    h3{
      font-size:18px; padding-top:20px; display:inline-block;
    }
      .btn {
        background: #e0e0e0;
        background-image: -webkit-linear-gradient(top, #e0e0e0, #b0b0b0);
        background-image: -moz-linear-gradient(top, #e0e0e0, #b0b0b0);
        background-image: -ms-linear-gradient(top, #e0e0e0, #b0b0b0);
        background-image: -o-linear-gradient(top, #e0e0e0, #b0b0b0);
        background-image: linear-gradient(to bottom, #e0e0e0, #b0b0b0);
        -webkit-border-radius: 28;
        -moz-border-radius: 28;
        border-radius: 28px;
        font-family: Arial;
        color: #ffffff;
        font-size: 20px;
        padding: 10px 20px 10px 20px;
        border: solid #d7d9db 2px;
        text-decoration: none;
        margin-bottom:20px;
      }
      
      .finish {
        background: #50616b;
        background-image: -webkit-linear-gradient(top, #50616b, #7f909c);
        background-image: -moz-linear-gradient(top, #50616b, #7f909c);
        background-image: -ms-linear-gradient(top, #50616b, #7f909c);
        background-image: -o-linear-gradient(top, #50616b, #7f909c);
        background-image: linear-gradient(to bottom, #50616b, #7f909c);
        text-decoration: none;
        color:white;
      }
      .task{
        padding:10px; border:1px solid #ddd;
        border-radius:5px; margin-bottom:5px;
        position:relative;
      }
      .task span:focus{
        outline:none;
      }

      .fade{
        background:#ddd;
      }
    </style>
    <script type="text/javascript">
      // Your Client ID can be retrieved from your project in the Google
      // Developer Console, https://console.developers.google.com
      var CLIENT_ID = '383204850743-8p1cu9u4g25cp82dhgqtce2qttj29976.apps.googleusercontent.com';
      var SYNCED_WITH_GOOGLE = false;
      var SCOPES = ["https://www.googleapis.com/auth/calendar","https://www.googleapis.com/auth/tasks"];
      function checkAuth() {
        gapi.auth.authorize(
          {
            'client_id': CLIENT_ID,
            'scope': SCOPES.join(' '),
            'immediate': true
          }, handleAuthResult);
      }
      var ACCESS_TOKEN;
      var CALENDAR_NAMES = []; 
      var CALENDAR_EVENTS = {};
      var TASKAPI = {
  "key":"AIzaSyBwRp5_WwKljeoKEWb9IMpWSVaHFzZDIas",
  "createList":function(name){
    $.ajax({ 
            type: 'POST',
            url: "https://www.googleapis.com/tasks/v1/users/@me/lists?key="+TASKAPI.key,
            headers: {
                "authorization":"Bearer "+ACCESS_TOKEN,
                "Content-Type":"application/json"
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
               console.log(textStatus);
               console.log(errorThrown);
               console.log(XMLHttpRequest);
            },
            data: JSON.stringify({"title":name})
        }).done(function(data) { 
            console.log("list created: "+name);
        });
  },
  "deleteTask":function(taskListID,taskID,obj,e){
    path = "https://www.googleapis.com/tasks/v1/lists/"+taskListID+"/tasks/"+taskID+"?key="+TASKAPI.key;
    $.ajax({ 
            type: 'DELETE',
            url: path,
            headers: {
                "authorization":"Bearer "+ACCESS_TOKEN,
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
               console.log(textStatus);
               console.log(errorThrown);
               console.log(XMLHttpRequest);
            }
        }).done(function(data) { 
            console.log("task deleted: ");
            $(obj).parent().addClass('fade');
            $(obj).parent().fadeTo(400,0,function(){
                $(obj).parent().remove();
            });
        });
  },
  "updateTask":function(taskListID,taskID,obj){
    console.log("update called");
    summary = $(obj).html();
    path = "https://www.googleapis.com/tasks/v1/lists/"+taskListID+"/tasks/"+taskID+"?key="+TASKAPI.key;
    $.ajax({ 
            type: 'PUT',
            url: path,
            headers: {
                "authorization":"Bearer "+ACCESS_TOKEN,
                "Content-Type":"application/json"
            },
            data: JSON.stringify({"id":taskID,"title":summary}),
            error: function(XMLHttpRequest, textStatus, errorThrown) {
               console.log(textStatus);
               console.log(errorThrown);
               console.log(XMLHttpRequest);
            }
        }).done(function(data) { 
            console.log("task updated: "+summary);
        });
      
    
  },
  "addTask":function(calendarID,taskListID,obj,e){
    console.log("here")
    e.preventDefault();
    e.stopPropagation();
    path = "https://www.googleapis.com/tasks/v1/lists/"+taskListID+"/tasks?key="+TASKAPI.key;
    $.ajax({ 
            type: 'POST',
            url: path,
            headers: {
                "authorization":"Bearer "+ACCESS_TOKEN,
                "Content-Type":"application/json"

            },
            data: JSON.stringify({"title":""}),
            error: function(XMLHttpRequest, textStatus, errorThrown) {
               console.log(textStatus);
               console.log(errorThrown);
               console.log(XMLHttpRequest);
            }
        }).done(function(task) { 
            console.log(task);
            title = task.title;
            if(title==""){
              title="&nbsp;";
            }
            tag = calendarID.substring(0,8);
            CALENDAR_EVENTS["CALENDAR_EVENT_"+tag+"_"+task.id] = {
              'summary': title.replace("&nbsp;",""),
              'location': '',
              'description': '',
              'start': {
                'dateTime': '',
              },
              'end': {
                'dateTime': '',
              }
            }; 
            template = `
             <div style="display:none" class="task" data-taskID="${task.id}">
              <span onblur="TASKAPI.updateTask('${taskListID}','${task.id}',this)" contenteditable style="width:100%; display:inline-block">${title}</span>
              <i id="button_${tag}_${task.id}" class="fa fa-calendar-o" onclick="TASKAPI.startButton('${taskListID}','${task.id}',this)" style="position:absolute; right:50px; top:11px; font-size:23px; color:#bbb;" aria-hidden="true"></i>
              <i class="fa fa-times" onclick="TASKAPI.deleteTask('${taskListID}','${task.id}',this,event)" aria-hidden="true" style="position:absolute; right:10px; top:9px; font-size:27px; color:#bbb;"></i>
              </div>
            `;
            div = $(template);
            $(obj).parent().parent().find("div.tasks").prepend(div);
            div.fadeTo(1000,1);
            div.find("span").focus();
            
        });
  },
  "log":function(taskListID,taskID,obj,e){
    e.preventDefault();
    e.stopPropagation();
    alert(taskListID+" "+taskID+" "+obj)
  },
  "toggleEditable":function(taskListID,taskID,obj,e){
    /*
    var value = $(obj).attr('contenteditable');
    console.log(value)
    if (value == 'false' || value == undefined) {
            console.log("here")
        $(obj).attr('contenteditable','true');
    }
    */
  },
  "blur":function(taskListID,taskID,obj,e){
    console.log('blurred')
  },
  "startButton":function(taskListID,taskID,obj){
    var id = $("#"+taskListID).attr("data-calendarID");
    tag = id.substring(0,8);
    if(SYNCED_WITH_GOOGLE){
      // get the time stamp
      // get the description
      localStorage.setItem("summary_"+tag+"_"+taskID, $(obj).parent().find("span").html());
      localStorage.setItem("start_"+tag+"_"+taskID, moment().format());
      localStorage.setItem("button_"+tag+"_"+taskID,"finish");
      TASKAPI.setButtonFinish(taskListID,taskID,obj)
    }else{
      alert('You need to authorize Google Calendars! Read below for instructions.')
    }
  },
  "finishButton":function(taskListID,taskID,obj){
     var id = $("#"+taskListID).attr("data-calendarID");
     tag = id.substring(0,8);
     CALENDAR_EVENTS["CALENDAR_EVENT_"+tag+"_"+taskID]['summary'] = localStorage.getItem("summary_"+tag+"_"+taskID).replace("&nbsp;","");
     CALENDAR_EVENTS["CALENDAR_EVENT_"+tag+"_"+taskID]['start']['dateTime'] = localStorage.getItem("start_"+tag+"_"+taskID);
     CALENDAR_EVENTS["CALENDAR_EVENT_"+tag+"_"+taskID]['end']['dateTime'] = moment().format();
      console.log(CALENDAR_EVENTS["CALENDAR_EVENT_"+tag+"_"+taskID]);
      console.log(id);
      var request = gapi.client.calendar.events.insert({
        'calendarId': id,
        'resource': CALENDAR_EVENTS["CALENDAR_EVENT_"+tag+"_"+taskID]
      });
      
      request.execute(function(event) {
        appendPre('Event created: ' + event.htmlLink);
      });
      
    localStorage.setItem("summary_"+tag+"_"+taskID,"");
    localStorage.setItem("start_"+tag+"_"+taskID,"");
    localStorage.setItem("end_"+tag+"_"+taskID,"");
    localStorage.setItem("button_"+tag+"_"+taskID,"start");
    
    // delete the task div
    TASKAPI.deleteTask(taskListID,taskID,obj,null);
    
  },
  "setButtonFinish":function(taskListID,taskID,obj){
    var id = $("#"+taskListID).attr("data-calendarID");
    tag = id.substring(0,8);
    $("#button_"+tag+"_"+taskID).removeClass('fa-calendar-o');
    $("#button_"+tag+"_"+taskID).addClass('fa-calendar-check-o');
    that = obj;
    $("#button_"+tag+"_"+taskID).parent().addClass("finish");
    $("#button_"+tag+"_"+taskID)[0].onclick = function(){ TASKAPI.finishButton(taskListID,taskID,that); }
  }
 
}    
      
      
      function handleAuthResult(authResult) {
        var authorizeDiv = document.getElementById('authorize-div');
        if (authResult && !authResult.error) {
          // Hide auth UI, then load client library.
          authorizeDiv.style.display = 'none';
          ACCESS_TOKEN = authResult.access_token;
          $.get( "https://www.googleapis.com/calendar/v3/users/me/calendarList?access_token="+authResult.access_token, function( data ) {
             
             data.items.forEach(function(calendar){
               if(calendar.accessRole=="owner" && calendar.selected){
                 tag = calendar.id.substring(0,8);

                 CALENDAR_NAMES.push({"summary":calendar.summary,"tag":tag,"id":calendar.id});

                 id = calendar.id;
                 CALENDAR_EVENTS["CALENDAR_EVENT"+tag] = {
                    'summary': localStorage.getItem("summary"+tag),
                    'location': '',
                    'description': 'I did this',
                    'start': {
                      'dateTime': localStorage.getItem("start"+tag),
                    },
                    'end': {
                      'dateTime': localStorage.getItem("end"+tag),
                    }
                  };
                 var buttonState = localStorage.getItem("button"+tag);
                 var description = localStorage.getItem("summary"+tag);
                 var template = `
                 <section id="section${tag}" class="page-header" style="background:${calendar.backgroundColor}; display:none;">
                  <h1 class="project-name">${calendar.summary}</h1>
                  <h2 class="project-tagline"></h2>
                  <input placeholder="What are you doing?" id="description${tag}" value="${description}" name="doing" style="border-radius:30px; padding:20px; border:none; text-align:center; width:100%; max-width:400px; color:black; margin-bottom:20px;" type="text" />
                  <span class="btn" id="button${tag}" onclick="startButton(this,'${calendar.id}')" style="width:160px; cursor:pointer;">Start</span>
                  <span id="created${tag}" style="display:none; color:white; font-size:18px;">Event created!</span>
                </section>
                 `;
                 $('#theCalendars').append(template);
                 console.log(calendar.summary+" section added");
                 if(buttonState == "finish"){
                   setButtonFinish($("#button"+tag)[0],id,tag);
                 }else{
                   setButtonStart($("#button"+tag)[0],id,tag);
                 }
               }
             }); 
             loadTasksApi();

             
          });
          loadCalendarApi();
        } else {
          // Show auth UI, allowing the user to initiate authorization by
          // clicking authorize button.
          authorizeDiv.style.display = 'inline';
        }
      }
      function handleAuthClick(event) {
        gapi.auth.authorize(
          {client_id: CLIENT_ID, scope: SCOPES, immediate: false},
          handleAuthResult);
        return false;
      }
      function loadCalendarApi() {
        SYNCED_WITH_GOOGLE = true;
        gapi.client.load('calendar', 'v3', listUpcomingEvents);
      }
      function loadTasksApi() {
        gapi.client.load('tasks', 'v1', listTaskLists);
      }
      function calendarHasTaskList(tl){
        calendarExists = false;
        for(cn in CALENDAR_NAMES){
                if(tl.title==CALENDAR_NAMES[cn]){
                  calendarExists = CALENDAR_NAMES[cn];
                }
            }
        return calendarExists;
      } 
      
  
              

      function listTaskLists() {
        $("#tasks").html(" "); 
        var request = gapi.client.tasks.tasklists.list({
            'maxResults': 10
          });
          
          
          request.execute(function(resp) {
            appendPre('Task Lists:');
            var taskLists = resp.items;
            console.log("TASK LISTS");
            console.log(taskLists);
            console.log(CALENDAR_NAMES)
            console.log(taskLists)
            if(taskLists && taskLists.length > 0) {
              CALENDAR_NAMES.forEach(function(cal){
                  hasList = false;
                  taskLists.forEach(function(tl){
                      if(tl.title==cal.summary){
                        hasList = cal.summary;
                      }
                  });
                  if(hasList==false){
                  console.log(cal.summary+" NEEDS TASKLIST");
                  TASKAPI.createList(cal.summary);
                  }else{ 
                  console.log(cal.summary+" doesn't need tasklist");  
                  //$('#section'+cal.tag).fadeTo(500,1);
                  }
              });
              taskLists.forEach(function(tasklist){
                hasCalendar = false;
                CALENDAR_NAMES.forEach(function(cal){
                      if(tasklist.title==cal.summary){
                        hasCalendar = cal.id;
                      }
                });
                if(hasCalendar){
                path = "https://www.googleapis.com/tasks/v1/lists/"+tasklist.id+"/tasks?access_token="+ACCESS_TOKEN;
                (function(hasCalendar,tasklist){
                  
                  $.get( path, function( data ) {
                    console.log(tasklist.title)
                    var temp = `
                      <div id="${tasklist.id}" data-calendarID="${hasCalendar}"><h3>${tasklist.title} <a  style="margin-left:8px; position:relative; top:-3px; text-align:center; width:25px; height:25px; background:#159957;" onclick="TASKAPI.addTask('${hasCalendar}','${tasklist.id}',this,event)" class="btn-floating waves-effect waves-light" aria-hidden="true"><span  style="position:relative; top:-7px; font-weight:100;">+</span></a></h3><div class="tasks"></div></div>
                    `;
                    $("#tasks").append(temp);
                    tag = hasCalendar.substring(0,8);
                    if(data.items && data.items.length >0){
                        data.items.forEach(function(task){
                          title = task.title;
                          if(title==""){
                            title="&nbsp;";
                          }
                        
                        CALENDAR_EVENTS["CALENDAR_EVENT_"+tag+"_"+task.id] = {
                          'summary': localStorage.getItem("summary_"+tag+"_"+task.id),
                          'location': '',
                          'description': '',
                          'start': {
                            'dateTime': localStorage.getItem("start_"+tag+"_"+task.id),
                          },
                          'end': {
                            'dateTime': localStorage.getItem("end_"+tag+"_"+task.id),
                          }
                        };  
                        var buttonState = localStorage.getItem("button_"+tag+"_"+task.id);
                        var template = `
                          <div class="task" data-taskID="${task.id}">
                          <span onblur="TASKAPI.updateTask('${tasklist.id}','${task.id}',this)" contenteditable style="width:100%; display:inline-block">${title}</span>
                          <i id="button_${tag}_${task.id}" class="fa fa-calendar-o" onclick="TASKAPI.startButton('${tasklist.id}','${task.id}',this)" style="position:absolute; right:50px; top:11px; font-size:23px; color:#bbb;" aria-hidden="true"></i>
                          <i class="fa fa-times" onclick="TASKAPI.deleteTask('${tasklist.id}','${task.id}',this,event)" aria-hidden="true" style="position:absolute; right:10px; top:9px; font-size:27px; color:#bbb;"></i>
                          </div>
                        `;
                        $("#"+tasklist.id+" div.tasks").append(template);
                        if(buttonState == "finish"){
                           TASKAPI.setButtonFinish(tasklist.id,task.id,$("#button_"+tag+"_"+task.id)[0]);
                         }else{
                           //TASKAPI.setButtonStart(tasklist.id,task.id,$("#button_"+tag+"_"+task.id)[0]);
                         }
                    }); 
                    }
                });
                  
                })(hasCalendar,tasklist)
                
                }
              })
              /*
              for (var i = 0; i < taskLists.length; i++) {
                var taskList = taskLists[i];
                appendPre(taskList.title + ' (' + taskList.id + ')');
              }
              */
            } else {
              appendPre('No task lists found.');
            }
          });
      }
      
      
      function listUpcomingEvents() {
        var request = gapi.client.calendar.events.list({
          'calendarId': 'primary',
          'timeMin': (new Date()).toISOString(),
          'showDeleted': false,
          'singleEvents': true,
          'maxResults': 10,
          'orderBy': 'startTime'
        });
    
        request.execute(function(resp) {
          var events = resp.items;
          appendPre('Upcoming events:');
    
          if (events.length > 0) {
            for (i = 0; i < events.length; i++) {
              var event = events[i];
              var when = event.start.dateTime;
              if (!when) {
                when = event.start.date;
              }
              appendPre(event.summary + ' (' + when + ')')
            }
          } else {
            appendPre('No upcoming events found.');
          }
    
        });
      }
    function appendPre(message) {
        //var pre = document.getElementById('output');
        //var textContent = document.createTextNode(message + '\n');
        //pre.appendChild(textContent);
      }
    
    function startButton(obj,id){
        var id = id || 'primary';
        tag = id.substring(0,8);
        if(SYNCED_WITH_GOOGLE){
          // get the time stamp
          // get the description
          localStorage.setItem("summary"+tag, $('#description'+tag).val());
          localStorage.setItem("start"+tag, moment().format());
          localStorage.setItem("button"+tag,"finish");
    
          setButtonFinish(obj,id,tag)
        }else{
          alert('You need to authorize Google Calendars! Read below for instructions.')
        }
      }
      
      function finishButton(obj,id){
         var id = id || 'primary';
         tag = id.substring(0,8);
         CALENDAR_EVENTS["CALENDAR_EVENT"+tag]['summary'] = localStorage.getItem("summary"+tag);
         CALENDAR_EVENTS["CALENDAR_EVENT"+tag]['start']['dateTime'] = localStorage.getItem("start"+tag);
         CALENDAR_EVENTS["CALENDAR_EVENT"+tag]['end']['dateTime'] = moment().format();
          console.log(CALENDAR_EVENTS["CALENDAR_EVENT"+tag]);
          console.log(id);
          var request = gapi.client.calendar.events.insert({
            'calendarId': id,
            'resource': CALENDAR_EVENTS["CALENDAR_EVENT"+tag]
          });
          
          request.execute(function(event) {
            appendPre('Event created: ' + event.htmlLink);
          });
          
        localStorage.setItem("summary"+tag,"");
        localStorage.setItem("start"+tag,"");
        localStorage.setItem("end"+tag,"");
        localStorage.setItem("button"+tag,"start");
        
        setButtonStart(obj,id,tag)
        $("#created"+tag).fadeTo(500,1,function(){
          $(this).fadeTo(500,0);
        });
      }
      
      function setButtonFinish(obj,id,tag){
          $("#button"+tag).html('Finish');
          that = obj;
          $("#button"+tag).addClass("finish");
          $("#button"+tag)[0].onclick = function(){ finishButton(that,id); }
      }
      function setButtonStart(obj,id,tag){
        $('#description'+tag).val("");
        $("#button"+tag).html('Start');
        that = obj;
        $("#button"+tag).removeClass("finish");
        $("#button"+tag)[0].onclick = function(){ startButton(that,id); }
      }
    
    </script>
    <script src="https://apis.google.com/js/client.js?onload=checkAuth"></script>
  </head>

  <body>
    <section class="page-header">
      <h1 class="project-name">What are you doing?</h1>
      <h2 class="project-tagline"></h2>
    </section>
    <section class="main-content">
      <h3>
        <a id="welcome-to-github-pages" class="anchor" href="#welcome-to-github-pages" aria-hidden="true">
          <span aria-hidden="true" class="octicon octicon-link"></span>
        </a>

Keep track of what you did today.</h3>
      <p>
  This app records the start time and end time of whatever you are doing and submits it as an event to Google Calendar, allowing you to keep a record of what you did during the day.
  </p>
      <div id="authorize-div" style="display: none">
        <span>Authorize access to Google Calendar API</span>
        <!--Button for the user to click to initiate auth sequence -->
        <button id="authorize-button" onclick="handleAuthClick(event)">
        Authorize
      </button>
      </div>
      <!--<pre id="output"></pre>-->
      
      
      <div id="tasks">
        
      </div>
      
      
    
      
      <footer class="site-footer">
        <span class="site-footer-owner">
          <a href="https://github.com/WebDesignerKits/what-are-you-doing">What-are-you-doing</a>

 is maintained by                     <a href="https://github.com/WebDesignerKits">WebDesignerKits</a>

.</span>
        <span class="site-footer-credits">This page was generated by                     <a href="https://pages.github.com">GitHub Pages</a>

 using the                     <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a>

 by                     <a href="https://twitter.com/jasonlong">Jason Long</a>

.</span>
      </footer>
    </section>
    <section id="theCalendars">
      
    </section>
      
      
  </body>

</html>
