<!DOCTYPE html>
<html>

  <head>
    <meta charset="UTF-8" />
    <!-- <link rel="manifest" href="manifest.json"> -->
    <meta property="og:image" content="http://calendartasks.com/logo.png" />
    <meta property="og:title" content="Calendar Tasks" />
    <meta property="og:description" content="Push completed tasks to your Google Calendar" />
    <link rel="icon" type="image/png" href="http://calendartasks.com/favicon.png" />
    <link rel="apple-touch-icon" sizes="57x57" href="http://calendartasks.com/57.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="http://calendartasks.com/72.png" />
    <link rel="apple-touch-icon" sizes="114x114" href="http://calendartasks.com/114.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="http://calendartasks.com/144.png" />
    <title>Calendar Tasks</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script data-require="jquery@*" data-semver="3.0.0" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0/jquery.js"></script>
    <script data-require="moment.js@*" data-semver="2.14.1" src="https://npmcdn.com/moment@2.14.1"></script>
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/css/materialize.min.css" />
    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/js/materialize.min.js"></script>
    <link rel="stylesheet" type="text/css" href="http://calendartasks.com/stylesheets/normalize.css" media="screen" />
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" type="text/css" href="http://calendartasks.com/stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="http://calendartasks.com/stylesheets/github-light.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
    <style>
    #description:focus{
      outline:none;
    }
    h3, .main-content h3{
      font-size:20px; padding-top:20px; display:inline-block;
      color:#4384F6;
      margin-top:0px;
    }
    #slide-out li{
      padding:0px 15px;
    }
    h2, .main-content h2{
      color:#4384F6;
      width:100%; text-align:center;
      margin-top:0px;
      margin-bottom:90px;
      font-size:40px;
      position:relative;
      top:0px;
    }
    .main-content p {
      margin-bottom:20px;
    }
    body{
      font-size:16px;
    }
    .main-content table td{
      border:none;
      vertical-align:top;
      text-align:left;
      padding-right:0px;
      padding-left:0px;
    }
    .main-content table td:first-of-type{
      padding-right:10px;
    }
      .btn {
        background: #e0e0e0;
        background-image: -webkit-linear-gradient(top, #e0e0e0, #b0b0b0);
        background-image: -moz-linear-gradient(top, #e0e0e0, #b0b0b0);
        background-image: -ms-linear-gradient(top, #e0e0e0, #b0b0b0);
        background-image: -o-linear-gradient(top, #e0e0e0, #b0b0b0);
        background-image: linear-gradient(to bottom, #e0e0e0, #b0b0b0);
        -webkit-border-radius: 28;
        -moz-border-radius: 28;
        border-radius: 28px;
        font-family: Arial;
        color: #ffffff;
        font-size: 20px;
        padding: 10px 20px 10px 20px;
        border: solid #d7d9db 2px;
        text-decoration: none;
        margin-bottom:20px;
      }
      
      .finish {
        background: #50616b;
        background-image: -webkit-linear-gradient(top, #50616b, #7f909c);
        background-image: -moz-linear-gradient(top, #50616b, #7f909c);
        background-image: -ms-linear-gradient(top, #50616b, #7f909c);
        background-image: -o-linear-gradient(top, #50616b, #7f909c);
        background-image: linear-gradient(to bottom, #50616b, #7f909c);
        text-decoration: none;
        color:white;
      }
      .task{
        padding:10px; border:1px solid #ddd;
        border-radius:5px; margin-bottom:5px;
        position:relative;
        font-size:16px;
      }
      .task span:focus{
        outline:none;
      }
      .fade{
        background:#ddd;
      }
      .main-content{
        padding:15px;
      }
    </style>
    <script type="text/javascript">
      // Your Client ID can be retrieved from your project in the Google
      // Developer Console, https://console.developers.google.com
      var CLIENT_ID = '383204850743-8p1cu9u4g25cp82dhgqtce2qttj29976.apps.googleusercontent.com';
      var SYNCED_WITH_GOOGLE = false;
      var SCOPES = ["https://www.googleapis.com/auth/calendar","https://www.googleapis.com/auth/tasks"];
      function checkAuth() {
        gapi.auth.authorize(
          {
            'client_id': CLIENT_ID,
            'scope': SCOPES.join(' '),
            'immediate': true
          }, handleAuthResult);
      }
      var ACCESS_TOKEN;
      var CALENDAR_NAMES = []; 
      var CALENDARS =[];
      var CALENDAR_EVENTS = {};
      var PROCESS_TASKS = [];
      var TASKS = [];
      var TASKLISTS_COMPLETED=0;
      var TASKLISTS = [];
      var TASKLISTS_WITH_CAL = [];
      var CALENDAR_ID_TASKLIST_MAP = {};
      var CALENDAR_ID_NAME_MAP = {};
      var currentlyUpdating;
      var TASKAPI = {
  "key":"AIzaSyBwRp5_WwKljeoKEWb9IMpWSVaHFzZDIas",
  "createList":function(name){
    $.ajax({ 
            type: 'POST',
            url: "https://www.googleapis.com/tasks/v1/users/@me/lists?key="+TASKAPI.key,
            headers: {
                "authorization":"Bearer "+ACCESS_TOKEN,
                "Content-Type":"application/json"
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
               alert(errorThrown)
               console.log(textStatus);
               console.log(errorThrown);
               console.log(XMLHttpRequest);
            },
            data: JSON.stringify({"title":name})
        }).done(function(data) { 
            console.log("list created: "+name);
        });
  },
  "delete":function(taskListID,taskID,obj,e){
    if($(obj).parent().hasClass("normal")){
      TASKAPI.deleteTask(taskListID,taskID,obj,e);
    }else{
      json = JSON.parse($("#taskwrap_"+taskListID+"_"+taskID).attr('data-taskNotes'));
      json.start = "";
      flatjson = JSON.stringify(json);
      $("#taskwrap_"+taskListID+"_"+taskID).attr('data-taskNotes',flatjson)
      TASKAPI.updateTaskNotes(taskListID,taskID,json.notes);
      TASKAPI.setButtonStart(taskListID,taskID,obj);
    }
  },
  "deleteTask":function(taskListID,taskID,obj,e){
    json = JSON.parse($("#taskwrap_"+taskListID+"_"+taskID).attr('data-taskNotes'));
    if(json.hasOwnProperty("calendarTask")){
      calendarId = $("#taskwrap_"+taskListID+"_"+taskID).attr('data-calendarID');
      var request = gapi.client.calendar.events.get({
          'calendarId': calendarId,
          'eventId': json.calendarTask,
        });
        request.execute(function(event) {
          event.description = "completed";
           var request = gapi.client.calendar.events.update({
              'calendarId': calendarId,
              'eventId': json.calendarTask,
              'resource':event
            });
            request.execute(function(event) {
                console.log("calendar event updated");
            });
        });
    }
    path = "https://www.googleapis.com/tasks/v1/lists/"+taskListID+"/tasks/"+taskID+"?key="+TASKAPI.key;
    $.ajax({ 
            type: 'DELETE',
            url: path,
            headers: {
                "authorization":"Bearer "+ACCESS_TOKEN,
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
               alert(errorThrown)
               console.log(textStatus);
               console.log(errorThrown);
               console.log(XMLHttpRequest);
            }
        }).done(function(data) { 
            console.log("task deleted: ");
            $("#taskwrap_"+taskListID+"_"+taskID).addClass('fade');
            $("#taskwrap_"+taskListID+"_"+taskID).fadeTo(400,0,function(){
                $("#taskwrap_"+taskListID+"_"+taskID).remove();
            });
        });
    
  },
  "updateTask":function(taskListID,taskID,obj,cb){
    currentlyUpdating = true;
    summary = $(obj).html();
    path = "https://www.googleapis.com/tasks/v1/lists/"+taskListID+"/tasks/"+taskID+"?key="+TASKAPI.key;
    $.ajax({ 
            type: 'PUT',
            url: path,
            headers: {
                "authorization":"Bearer "+ACCESS_TOKEN,
                "Content-Type":"application/json"
            },
            data: JSON.stringify({"id":taskID,"title":summary}),
            error: function(XMLHttpRequest, textStatus, errorThrown) {
               alert(textStatus)
               console.log(textStatus);
               console.log(errorThrown);
               console.log(XMLHttpRequest);
            }
        }).done(function(data) { 
          currentlyUpdating = false;
          console.log("update succes:");
          console.log(data)
          if(typeof cb == 'function'){
            cb();
          }
            //console.log("task updated: "+summary);
        });
      
    
  },
  "addTask":function(calendarID,taskListID,obj,e){
    e.preventDefault();
    e.stopPropagation();
    path = "https://www.googleapis.com/tasks/v1/lists/"+taskListID+"/tasks?key="+TASKAPI.key;
    $.ajax({ 
            type: 'POST',
            url: path,
            headers: {
                "authorization":"Bearer "+ACCESS_TOKEN,
                "Content-Type":"application/json"
            },
            data: JSON.stringify({"title":""}),
            error: function(XMLHttpRequest, textStatus, errorThrown) {
               alert(textStatus)
               console.log(textStatus);
               console.log(errorThrown);
               console.log(XMLHttpRequest);
            }
        }).done(function(task) { 
            console.log("task created")
            task = TASKAPI.setTaskPriority(task);
            console.log(task);
            title = task.title;
            if(title==""){
              title=" ";
            }
            tag = calendarID.substring(0,8);
            CALENDAR_EVENTS["CALENDAR_EVENT_"+tag+"_"+task.id] = {
              'summary': title.replace("&nbsp;",""),
              'location': '',
              'description': '',
              'start': {
                'dateTime': '',
              },
              'end': {
                'dateTime': '',
              }
            }; 
            notes = `{"start":""}`;
            template = `
             <div id="taskwrap_${taskListID}_${task.id}" style="display:none" class="task normal" data-taskID="${task.id}"  data-taskNotes='${notes}' data-taskDue="${task.due}" data-taskPriority="${task.priority}">
              <span onblur="TASKAPI.updateTask('${taskListID}','${task.id}',this)" contenteditable style="width:70%; display:inline-block">${title}</span>
              <i id="button_${tag}_${task.id}" class="fa fa-calendar-o" onclick="TASKAPI.startButton('${taskListID}','${task.id}',this)" style="position:absolute; right:50px; top:11px; font-size:23px;" aria-hidden="true"></i>
              <i class="fa fa-times" onclick="TASKAPI.delete('${taskListID}','${task.id}',this,event)" aria-hidden="true" style="position:absolute; right:10px; top:9px; font-size:27px;"></i>
              <i class="fa fa-clock-o" onclick="TASKAPI.prioritize('${taskListID}','${task.id}',this)" style="position:absolute; right:90px; top:9px; font-size:27px;" aria-hidden="true"></i>
              </div>
            `;
            div = $(template);
            $(obj).parent().parent().find("div.tasks").prepend(div);
            div.fadeTo(1000,1);
            div.find("span").focus();
            
        });
  },
  "addCalendarTask":function(calendarID,taskListID,calendarEvent){
    
    path = "https://www.googleapis.com/tasks/v1/lists/"+taskListID+"/tasks?key="+TASKAPI.key;
    $.ajax({ 
            type: 'POST',
            url: path,
            headers: {
                "authorization":"Bearer "+ACCESS_TOKEN,
                "Content-Type":"application/json"
            },
            data: JSON.stringify({"title":calendarEvent.summary, "notes":JSON.stringify({"start":"","calendarTask":calendarEvent.id}) }),
            error: function(XMLHttpRequest, textStatus, errorThrown) {
               alert(textStatus);
               console.log(textStatus);
               console.log(errorThrown);
               console.log(XMLHttpRequest);
            }
        }).done(function(task) { 
            task = TASKAPI.setTaskPriority(task);
            console.log("calendarTask created:")
            console.log(task);
            title = task.title;
            if(title==""){
              title=" ";
            }
            tag = calendarID.substring(0,8);
            CALENDAR_EVENTS["CALENDAR_EVENT_"+tag+"_"+task.id] = {
              'summary': title.replace("&nbsp;",""),
              'location': '',
              'description': '',
              'start': {
                'dateTime': '',
              },
              'end': {
                'dateTime': '',
              }
            }; 
            notes = `{"start":"","calendarTask":"${calendarEvent.id}"}`;
            template = `
             <div id="taskwrap_${taskListID}_${task.id}" style="display:none" class="task normal" data-taskID="${task.id}"  data-taskNotes='${notes}' data-taskDue="${task.due}" data-taskPriority="${task.priority}">
              <span onblur="TASKAPI.updateTask('${taskListID}','${task.id}',this)" contenteditable style="width:80%; display:inline-block">${title}</span>
              <i id="button_${tag}_${task.id}" class="fa fa-calendar-o" onclick="TASKAPI.startButton('${taskListID}','${task.id}',this)" style="position:absolute; right:50px; top:11px; font-size:23px;" aria-hidden="true"></i>
              <i class="fa fa-times" onclick="TASKAPI.delete('${taskListID}','${task.id}',this,event)" aria-hidden="true" style="position:absolute; right:10px; top:9px; font-size:27px;"></i>
              <i class="fa fa-clock-o" onclick="TASKAPI.prioritize('${taskListID}','${task.id}',this)" style="position:absolute; right:90px; top:9px; font-size:27px;" aria-hidden="true"></i>
              </div>
            `;
            div = $(template);
            $("#"+taskListID).find("div.tasks").prepend(div);
            div.fadeTo(1000,1);
        });
  },
  "log":function(taskListID,taskID,obj,e){
    e.preventDefault();
    e.stopPropagation();
    alert(taskListID+" "+taskID+" "+obj)
  },
  "toggleEditable":function(taskListID,taskID,obj,e){
    /*
    var value = $(obj).attr('contenteditable');
    console.log(value)
    if (value == 'false' || value == undefined) {
            console.log("here")
        $(obj).attr('contenteditable','true');
    }
    */
  },
  "blur":function(taskListID,taskID,obj,e){
    console.log('blurred')
  },
  "startButton":function(taskListID,taskID,obj){
    if(currentlyUpdating == true){
      setTimeout(function(){
        TASKAPI.startButton(taskListID,taskID,obj);
      },250);
    }else{
      console.log("START BUTTON")
      console.log(taskListID+" "+taskID)
      console.log(obj)
      var id = $("#"+taskListID).attr("data-calendarID");
      tag = id.substring(0,8);
      if(SYNCED_WITH_GOOGLE){
        // get the time stamp
        // get the description
        localStorage.setItem("summary_"+tag+"_"+taskID, $(obj).parent().find("span").html());
        localStorage.setItem("start_"+tag+"_"+taskID, moment().format());
        localStorage.setItem("button_"+tag+"_"+taskID,"finish");
        json = JSON.parse($("#taskwrap_"+taskListID+"_"+taskID).attr('data-taskNotes'));
        json.start = moment().format();
        flatjson = JSON.stringify(json);
        $("#taskwrap_"+taskListID+"_"+taskID).attr('data-taskNotes',flatjson);
        TASKAPI.updateTaskNotes(taskListID,taskID,json.notes,function(){
          TASKAPI.setButtonFinish(taskListID,taskID,obj);
        });
      }else{
        alert('You need to authorize Google Calendars! Read below for instructions.')
      }
    }
  },
  "finishButton":function(taskListID,taskID,obj){
       console.log("FINISH BUTTON");
       localStorage.setItem("summary_"+tag+"_"+taskID,$("#taskwrap_"+taskListID+"_"+taskID+" span").html());
       var id = $("#"+taskListID).attr("data-calendarID");
       tag = id.substring(0,8);
       var json = JSON.parse($("#taskwrap_"+taskListID+"_"+taskID).attr('data-taskNotes'));
       
       CALENDAR_EVENTS["CALENDAR_EVENT_"+tag+"_"+taskID]['summary'] = $("#taskwrap_"+taskListID+"_"+taskID+" span").html().replace("&nbsp;","");
       CALENDAR_EVENTS["CALENDAR_EVENT_"+tag+"_"+taskID]['start']['dateTime'] = json.start;
       CALENDAR_EVENTS["CALENDAR_EVENT_"+tag+"_"+taskID]['end']['dateTime'] = moment().format();
       CALENDAR_EVENTS["CALENDAR_EVENT_"+tag+"_"+taskID]['description'] = json.notes;
        console.log("sending event to google");
        console.log(CALENDAR_EVENTS["CALENDAR_EVENT_"+tag+"_"+taskID]);
        
        var request = gapi.client.calendar.events.insert({
          'calendarId': id,
          'resource': CALENDAR_EVENTS["CALENDAR_EVENT_"+tag+"_"+taskID]
        });
        
        request.execute(function(event) {
          appendPre('Event created: ' + event.htmlLink);
        });
        
      localStorage.setItem("summary_"+tag+"_"+taskID,"");
      localStorage.setItem("start_"+tag+"_"+taskID,"");
      localStorage.setItem("end_"+tag+"_"+taskID,"");
      localStorage.setItem("button_"+tag+"_"+taskID,"start");
      
      // delete the task div
      TASKAPI.deleteTask(taskListID,taskID,obj,null);
    
    
  },
  "setButtonFinish":function(taskListID,taskID,obj){
    var id = $("#"+taskListID).attr("data-calendarID");
    tag = id.substring(0,8);
    $("#button_"+tag+"_"+taskID).removeClass('fa-calendar-o');
    $("#button_"+tag+"_"+taskID).addClass('fa-calendar-check-o');
    that = obj;
    $("#taskwrap_"+taskListID+"_"+taskID).removeClass("normal");
    $("#button_"+tag+"_"+taskID)[0].onclick = function(){ TASKAPI.finishButton(taskListID,taskID,that); }
  },
  "setButtonStart":function(taskListID,taskID,obj){
    var id = $("#"+taskListID).attr("data-calendarID");
    tag = id.substring(0,8);
    $("#button_"+tag+"_"+taskID).removeClass('fa-calendar-check-o');
    $("#button_"+tag+"_"+taskID).addClass('fa-calendar-o');
    that = obj;
    $("#taskwrap_"+taskListID+"_"+taskID).addClass("normal");
    $("#button_"+tag+"_"+taskID)[0].onclick = function(){ TASKAPI.startButton(taskListID,taskID,that); }
    localStorage.setItem("button_"+tag+"_"+taskID,"start");
  },
  "prioritize":function(taskListID,taskID,obj){
    var listTitle = $("#"+taskListID+" h3 span.taskTitle").html();
    var bgColor = $("#"+taskListID+" h3").css("background");
    var json = JSON.parse($("#taskwrap_"+taskListID+"_"+taskID).attr("data-taskNotes"));
    if(json.notes==undefined){
      json.notes = "";
    }
    var taskDue = $("#taskwrap_"+taskListID+"_"+taskID).attr("data-taskDue");
    var taskPriority = $("#taskwrap_"+taskListID+"_"+taskID).attr("data-taskPriority");
    var template = `
    <div style="padding:15px; font-size:20px; background:${bgColor}; color:white;">${listTitle}</div>
    <li>Notes <i class="fa fa-pencil" aria-hidden="true"></i><br/>
    <textarea  onblur="TASKAPI.updateTaskNotes('${taskListID}','${taskID}',this.value)" style="border:1px solid #ddd; border-radius:5px; padding:15px 15px; line-height:16px; font-size:16px; height:300px">${json.notes}</textarea>
    </li>
    <li><i class="fa fa-clock-o" aria-hidden="true"></i> Days left until task due:<br/>
    <span onblur="TASKAPI.updateTaskDue('${taskListID}','${taskID}',this.innerHTML)" contentEditable style=" width:50px; padding:10px; border:1px solid #ddd; border-radius:5px; ">
    ${taskPriority}
    </span>
    
    </li>
    `;
    $("#slide-out").html(template);
    $('.button-collapse').sideNav('show');
  },
  "updateTaskDue":function(taskListID,taskID,val){
    currentlyUpdating = true;
    $("#taskwrap_"+taskListID+"_"+taskID).attr("data-taskPriority",val);
    today = moment();
    newDueDate = today.add(val,"day").format()
    //.add(val, 'day').format();
    $("#taskwrap_"+taskListID+"_"+taskID).attr("data-taskDue",newDueDate);
    localStorage.setItem("due"+tag+"_"+taskID,newDueDate);
    path = "https://www.googleapis.com/tasks/v1/lists/"+taskListID+"/tasks/"+taskID+"?key="+TASKAPI.key;
    $.ajax({ 
            type: 'PUT',
            url: path,
            headers: {
                "authorization":"Bearer "+ACCESS_TOKEN,
                "Content-Type":"application/json"
            },
            data: JSON.stringify({"id":taskID,"due":newDueDate}),
            error: function(XMLHttpRequest, textStatus, errorThrown) {
               alert(textStatus)
               console.log(textStatus);
               console.log(errorThrown);
               console.log(XMLHttpRequest);
            }
        }).done(function(data) { 
            currentlyUpdating = false;
            console.log(data);
        });
  },
  "updateTaskNotes":function(taskListID,taskID,val,cb){
    currentlyUpdating = true;
    console.log("updateTaskNotes()");
    var id = $("#"+taskListID).attr("data-calendarID");
    tag = id.substring(0,8);
    console.log(val)
    originalNotes = JSON.parse($("#taskwrap_"+taskListID+"_"+taskID).attr("data-taskNotes"));
    originalNotes.notes = val;
    flatNotes = JSON.stringify(originalNotes);
    $("#taskwrap_"+taskListID+"_"+taskID).attr("data-taskNotes",flatNotes);

    path = "https://www.googleapis.com/tasks/v1/lists/"+taskListID+"/tasks/"+taskID+"?key="+TASKAPI.key;
    $.ajax({ 
            type: 'PUT',
            url: path,
            headers: {
                "authorization":"Bearer "+ACCESS_TOKEN,
                "Content-Type":"application/json"
            },
            data: JSON.stringify({"id":taskID,"notes":flatNotes}),
            error: function(XMLHttpRequest, textStatus, errorThrown) {
               alert(textStatus)
               console.log(textStatus);
               console.log(errorThrown);
               console.log(XMLHttpRequest);
            }
        }).done(function(data) { 
           currentlyUpdating = false;
            console.log("update note success:")
            console.log(data);
            if(typeof cb == "function"){
              cb();
            }
        });
    
    
  },
  "setTaskPriority":function (task){
    today = moment();
    //console.log("today: "+today.format());
    task.due = moment(task.due);
    diff = task.due.diff(today);
    //console.log("difference : "+diff)
    task.priority = moment.duration(diff).asDays().toFixed(2);
    task.due = task.due.format();
    //console.log("priority: "+task.priority);
    return task;
  },
  "toggleColors":function(val){
      localStorage.setItem("defaultColors",val);
      setTimeout(function(){
        location.reload();
      },1000);
    
  }
 
}    

      function handleAuthResult(authResult) {
        var authorizeDiv = document.getElementById('authorize-div');
        if (authResult && !authResult.error) {
          // Hide auth UI, then load client library.
          authorizeDiv.style.display = 'none';
          ACCESS_TOKEN = authResult.access_token;
          $.get( "https://www.googleapis.com/calendar/v3/users/me/calendarList?access_token="+authResult.access_token, function( data ) {
             console.log('-LOAD CALENDARS-')
             data.items.forEach(function(calendar){
               //console.log("LOADED: "+calendar.summary)
               if(calendar.accessRole=="owner"){
                 tag = calendar.id.substring(0,8); 
                 CALENDAR_NAMES.push(calendar);
                 CALENDAR_ID_NAME_MAP[calendar.summary] = calendar.id;
                 console.log("PUSHED: "+calendar.summary)
               }else{
                 //console.log(calendar.summary+" not pushed")
               }
             }); 
             console.log('-CALENDARS LOADED-')

             loadTasksApi();
          });
          loadCalendarApi();
        } else {
          // Show auth UI, allowing the user to initiate authorization by
          // clicking authorize button.
          authorizeDiv.style.display = 'inline';
        }
      }
      function handleAuthClick(event) {
        gapi.auth.authorize(
          {client_id: CLIENT_ID, scope: SCOPES, immediate: false},
          handleAuthResult);
        return false;
      }
      function loadCalendarApi() {
        SYNCED_WITH_GOOGLE = true;
        gapi.client.load('calendar', 'v3', function(){});
      }
      function loadTasksApi() {
        gapi.client.load('tasks', 'v1', gatherTasks);
      }
      function calendarHasTaskList(tl){
        calendarExists = false;
        for(cn in CALENDAR_NAMES){
                if(tl.title==CALENDAR_NAMES[cn]){
                  calendarExists = CALENDAR_NAMES[cn];
                }
            }
        return calendarExists;
      } 
      var nextPageToken;
      function gatherTasks(){
        console.log('-GATHERING TASKS-')
        var request = gapi.client.tasks.tasklists.list({"pageToken":nextPageToken});
        request.execute(function(resp) {
          var taskLists = resp.items;
            taskLists.forEach(function(tl){
              TASKLISTS.push(tl);
            });
          if(resp.hasOwnProperty("nextPageToken")){
               nextPageToken = resp.nextPageToken;
               gatherTasks();
            
          }else{
            console.log('-TASKS GATHERED-');
              listTaskLists();
          }
        });
      }
      function listTaskLists() {
        $("#tasks").html(" "); 
            var taskLists = TASKLISTS;
            taskLists.sort(compare)
            if(taskLists && taskLists.length > 0) {
              console.log('-DISPLAY TASKS-')
              CALENDAR_NAMES.forEach(function(cal){
                  hasList = false;
                  taskLists.forEach(function(tl){
                      if(tl.title==cal.summary){
                        hasList = cal.summary;
                        //TASKLISTS_WITH_CAL.push(tl);
                        CALENDAR_ID_TASKLIST_MAP[cal.id]=tl.id;
                      }
                  });
                  if(hasList==false){
                  console.log(cal.summary+" NEEDS TASKLIST");
                  TASKAPI.createList(cal.summary);
                  }else{ 
                  console.log(cal.summary+" doesn't need tasklist");  
                  //$('#section'+cal.tag).fadeTo(500,1);
                  }
              });
              
              taskLists.forEach(function(tasklist){
                console.log(tasklist.title)
                hasCalendar = false;
                CALENDAR_NAMES.forEach(function(cal){
                      if(tasklist.title==cal.summary){
                        hasCalendar = cal;
                        TASKLISTS_WITH_CAL.push(tasklist);
                      }
                });
                
                if(hasCalendar){
                if(localStorage.getItem("defaultColors")=="true"){
                  backgroundColor = "#4384F6";
                }else{
                  backgroundColor = hasCalendar.backgroundColor;
                }
                path = "https://www.googleapis.com/tasks/v1/lists/"+tasklist.id+"/tasks?access_token="+ACCESS_TOKEN;
                (function(hasCalendar,tasklist){
                  
                  var temp = `
                      <div id="${tasklist.id}" style="margin-bottom:15px;" data-calendarID="${hasCalendar.id}">
                      <h3 style="color:white; background:${backgroundColor}; padding:10px; padding-left:25px; padding-right:10px; padding-bottom:5px; position:relative; left:-25px; border-top-right-radius:25px; border-bottom-right-radius:25px; ">
                      <span class="taskTitle tasksHidden" style="height:28px; display:inline-block; margin-right:6px;" onclick="toggleTasks('${tasklist.id}',this)">${tasklist.title}</span> 
                      <span style="display:none; position:relative; top:-3px; text-align:center; width:28px; height:28px; background:#159957; background:#4384F6; background:white;" onclick="TASKAPI.addTask('${hasCalendar.id}','${tasklist.id}',this,event)" class="btn-floating waves-effect waves-dark" aria-hidden="true">      
                        <style>
                        #${tasklist.id} div.task{
                          background:${backgroundColor};
                        }
                        #${tasklist.id} div.task i{
                          color:white;
                        }
                        #${tasklist.id} div.task span{
                          color:white;
                        }
                        #${tasklist.id} div.task.normal{
                          background:white;
                        }
                        #${tasklist.id} div.task.normal span{
                          color:#777;
                        }
                          #${tasklist.id} div.task.normal i{
                          color:#bbb;
                        }
                        </style>
                      <?xml version="1.0" encoding="utf-8"?>
                      <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                      	 viewBox="0 0 212 212" style="width:100%; height:100%; enable-background:new 0 0 212 212;" xml:space="preserve">
                      <rect x="102.7" y="75" style="fill:${backgroundColor}" width="6.7" height="62"/>
                      <rect x="102.7" y="75" style="fill:${backgroundColor}" transform="matrix(-1.836970e-16 1 -1 -1.836970e-16 212 1.421085e-14)"  width="6.7" height="62"/>
                      </svg>
                      </span></h3><div class="tasks" style="display:none;"></div></div>
                    `;
                    $("#tasks").append(temp);
                    
                  $.get( path, function( data ) {
                    tag = hasCalendar.id.substring(0,8);
                    if(data.items && data.items.length >0){
                        // arrange items by priority
                        theTasks  = [];
                        data.items.forEach(function(task){
                          theTasks.push(task);
                        });
                        theTasks.forEach(function(task){
                          task = TASKAPI.setTaskPriority(task);
                        });
                        theTasks.sort(function compare(a,b) {
                          if (a.priority < b.priority)
                            return -1;
                          if (a.priority > b.priority)
                            return 1;
                          return 0;
                        }  )
                        // loop tasks
                        theTasks.forEach(function(task){
                          task.calendarID = hasCalendar.id; 
                          title = task.title;
                          if(title==""){
                            title=" ";
                          }
                        CALENDAR_EVENTS["CALENDAR_EVENT_"+tag+"_"+task.id] = {
                          'summary': localStorage.getItem("summary_"+tag+"_"+task.id),
                          'location': '',
                          'description': localStorage.getItem("description_"+tag+"_"+task.id),
                          'start': {
                            'dateTime': localStorage.getItem("start_"+tag+"_"+task.id),
                          },
                          'end': {
                            'dateTime': localStorage.getItem("end_"+tag+"_"+task.id),
                          }
                        };  
                        var buttonState = localStorage.getItem("button_"+tag+"_"+task.id);
                        nt = task.notes;
                        if(!isJSON(nt)){
                          notes={"start":"","notes":nt};
                        }else{
                          notes = JSON.parse(nt);
                        }
                        task.json = notes;
                        var template = `
                          <div data-calendarID="${task.calendarID}" id="taskwrap_${tasklist.id}_${task.id}" class="task normal" data-taskID="${task.id}" data-taskNotes='${JSON.stringify(notes)}' data-taskDue="${task.due}" data-taskPriority="${task.priority}">
                          <span onblur="TASKAPI.updateTask('${tasklist.id}','${task.id}',this)" contenteditable style="width:70%; display:inline-block">${title}</span>
                          <i id="button_${tag}_${task.id}" class="fa fa-calendar-o" onclick="TASKAPI.startButton('${tasklist.id}','${task.id}',this)" style="position:absolute; right:49px; top:11px; font-size:23px; " aria-hidden="true"></i>
                          <i class="fa fa-times" onclick="TASKAPI.delete('${tasklist.id}','${task.id}',this,event)" aria-hidden="true" style="position:absolute; right:10px; top:9px; font-size:27px;"></i>
                          <i class="fa fa-clock-o" onclick="TASKAPI.prioritize('${tasklist.id}','${task.id}',this)" style="position:absolute; right:90px; top:9px; font-size:27px;" aria-hidden="true"></i>
                          </div>
                        `;
                        $("#"+tasklist.id+" div.tasks").append(template);
                        if(notes.start != ""){
                           TASKAPI.setButtonFinish(tasklist.id,task.id,$("#button_"+tag+"_"+task.id)[0]);
                         }else{
                           TASKAPI.setButtonStart(tasklist.id,task.id,$("#button_"+tag+"_"+task.id)[0]);
                         }
                         pushTASKS(task);
                    }); 
                    }
                    TASKLISTS_COMPLETED++;
                    tasklistCompleted();
                });
                })(hasCalendar,tasklist)
                }
              });
              $("#ads").css("margin-top","150px");
            } else {
              appendPre('No task lists found.');
            }
      }
      function tasklistCompleted(){
        if(TASKLISTS_WITH_CAL.length == TASKLISTS_COMPLETED){
          console.log("-TASKS DISPLAYED-");
          TASKS.forEach(function(task){
            //console.log(task)
          })
          CALENDAR_NAMES.forEach(function(cal){
            if(cal.summary!="PLAN"){
              listUpcomingEvents(cal.id)
            }
          });
          TASKLISTS.forEach(function(tasklist){
            console.log(localStorage.getItem("toggleHeader_"+tasklist.id))
            if(localStorage.getItem("toggleHeader_"+tasklist.id)!="hide"){
              console.log("showing: "+tasklist.title)
              showTasks(tasklist.id,$("#"+tasklist.id+" .taskTitle"))
            }
          });
        }
      }
      function pushTASKS(task){
        TASKS.push(task);
      }
      function listUpcomingEvents(calID) {
        var request = gapi.client.calendar.events.list({
          'calendarId': calID,
          'timeMin': (new Date()).toISOString(),
          'timeMax': moment().add(1,'day').endOf('day').format(),
          'showDeleted': false,
          'singleEvents': true,
          'maxResults': 100,
          'orderBy': 'startTime'
        });
        var calID = calID;
        request.execute(function(resp) {
          var events = resp.items;
          events.forEach(function(event){
            task_doesnt_exists = true;
            TASKS.forEach(function(task){
              if(task.json.hasOwnProperty("calendarTask")){
                if(task.json.calendarTask == event.id){
                  task_doesnt_exists = false;
                }
              }
            });
            if(task_doesnt_exists){
              if(event.description!="completed"){
              console.log("create this upcoming task");
              console.log(event)
              
              calendarEvent = event;
              if(calendarEvent.description!=""){
                if(CALENDAR_ID_NAME_MAP.hasOwnProperty(calendarEvent.description)){
                calID = CALENDAR_ID_NAME_MAP[calendarEvent.description];
                }else{
                  calID = calID;
                }
              }
              //  "addCalendarTask":function(calendarID,taskListID,calendarEvent,obj){
              TASKAPI.addCalendarTask(calID, CALENDAR_ID_TASKLIST_MAP[calID],calendarEvent)
              }
            }
            // event.id, event.summary
          })
    
        });
      }
      
      function compare(a,b) {
        if (a.title < b.title)
          return -1;
        if (a.title > b.title)
          return 1;
        return 0;
      }  
    function isJSON(str) {
        try {
            JSON.parse(str);
        } catch (e) {
            return false;
        }
        return true;
    }  
    function appendPre(message) {
        //var pre = document.getElementById('output');
        //var textContent = document.createTextNode(message + '\n');
        //pre.appendChild(textContent);
      }
   
    function startButton(obj,id){
        var id = id || 'primary';
        tag = id.substring(0,8);
        if(SYNCED_WITH_GOOGLE){
          // get the time stamp
          // get the description
          localStorage.setItem("summary"+tag, $('#description'+tag).val());
          localStorage.setItem("start"+tag, moment().format());
          localStorage.setItem("button"+tag,"finish");
    
          setButtonFinish(obj,id,tag)
        }else{
          alert('You need to authorize Google Calendars! Read below for instructions.')
        }
      }
     
      function finishButton(obj,id){
        console.log("FINISH BUTTON")
         var id = id || 'primary';
         tag = id.substring(0,8);
         CALENDAR_EVENTS["CALENDAR_EVENT"+tag]['summary'] = localStorage.getItem("summary"+tag);
         CALENDAR_EVENTS["CALENDAR_EVENT"+tag]['start']['dateTime'] = localStorage.getItem("start"+tag);
         CALENDAR_EVENTS["CALENDAR_EVENT"+tag]['end']['dateTime'] = moment().format();
          console.log(CALENDAR_EVENTS["CALENDAR_EVENT"+tag]);
          console.log(id);
          var request = gapi.client.calendar.events.insert({
            'calendarId': id,
            'resource': CALENDAR_EVENTS["CALENDAR_EVENT"+tag]
          });
          
          request.execute(function(event) {
            appendPre('Event created: ' + event.htmlLink);
          });
          
        localStorage.setItem("summary"+tag,"");
        localStorage.setItem("start"+tag,"");
        localStorage.setItem("end"+tag,"");
        localStorage.setItem("button"+tag,"start");
        
        setButtonStart(obj,id,tag)
        $("#created"+tag).fadeTo(500,1,function(){
          $(this).fadeTo(500,0);
        });
      }
      
      function setButtonFinish(obj,id,tag){
          $("#button"+tag).html('Finish');
          that = obj;
          $("#button"+tag).addClass("finish");
          $("#button"+tag)[0].onclick = function(){ finishButton(that,id); }
      }
      function setButtonStart(obj,id,tag){
        $('#description'+tag).val("");
        $("#button"+tag).html('Start');
        that = obj;
        $("#button"+tag).removeClass("finish");
        $("#button"+tag)[0].onclick = function(){ startButton(that,id); }
      }
      
   
    function hideInstructions(){
      $("#instructions").slideUp('slow');
      $("#showInstructions").fadeTo(500,1);
      localStorage.setItem("instructions","hide");
    }
    function showInstructions(){
      $("#instructions").slideDown('slow');
      $("#showInstructions").hide();
      $('html,body').scrollTop(0);
      localStorage.setItem("instructions","show");
    }
    
    
    function toggleTasks(tasklistid, obj){
      console.log("toggleTasks()")
      console.log($(obj).hasClass("tasksHidden"))
      if($(obj).hasClass("tasksHidden")){
        showTasks(tasklistid,obj);
      }else{
        hideTasks(tasklistid,obj);
      }
    }
    
    function showAllTasks(){
      TASKLISTS.forEach(function(task){
        showTasks(task.id,$('#'+task.id+" .taskTitle"));
      });
    }
    function hideAllTasks(){
      TASKLISTS.forEach(function(task){
        hideTasks(task.id,$('#'+task.id+" .taskTitle"));
      });
    }
    function hideTasks(tasklistid,obj){
      $(obj).addClass("tasksHidden");
        $(obj).parent().next().hide();
        $(obj).next().hide();
        localStorage.setItem("toggleHeader_"+tasklistid,"hide");
    }
    function showTasks(tasklistid,obj){
      $(obj).removeClass("tasksHidden");
        $(obj).parent().next().show();
        $(obj).next().show();
        localStorage.setItem("toggleHeader_"+tasklistid,"show");
    }
    
     $(function(){
      ins = localStorage.getItem("instructions");
      if(ins=="hide"){
        $("#instructions").hide();
        $("#showInstructions").show();
      }else{
        $("#instructions").show();
        $("#showInstructions").hide();
      }
      $(".button-collapse").sideNav();
      defaultColors = localStorage.getItem("defaultColors");
      console.log("default color is: "+defaultColors);
      console.log(defaultColors=="true");
      if(defaultColors=="true"){
        $("#defaultColors")[0].checked = true;
      }else{
        $("#defaultColors")[0].checked = false;
      }
    })
    </script>
    <script src="https://apis.google.com/js/client.js?onload=checkAuth"></script>
  </head>

  <body>
    <pre id="output"></pre>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-89087680-1', 'auto');
  ga('send', 'pageview');
    </script>
    <ul id="slide-out" class="side-nav"></ul>
    <a href="#" data-activates="slide-out" class="button-collapse"></a>
    <!--<section class="page-header">-->
    <!--  <h1 class="project-name">What are you doing?</h1>-->
    <!--  <h2 class="project-tagline"></h2>-->
    <!--</section>-->
    <section class="main-content">
      <div style="width:100%; position:relative; text-align:center;">
        <img style="width:300px; position:relative; margin:auto;" src="http://calendartasks.com/logo_short.png" />
      </div>
      <br />
      <h2>Calendar Tasks</h2>
      <div id="instructions" style="display:none">
        <h3>Calendar Tasks</h3>
        <p>A task list that automatically pushes finished tasks to Google Calendar as past events. </p>
        <h3>How it works</h3>
        <div id="authorize-div" style="display: none">
          <span>Authorize access to Google Calendar API</span>
          <!--Button for the user to click to initiate auth sequence -->
          <button id="authorize-button" onclick="handleAuthClick(event)">
        Authorize
      </button>
        </div>
        <p>
        Create new task lists by creating new calendars in           <a href="https://calendar.google.com">Google Calendar</a>
. These become your task lists. (You may need to refresh a few times for them to sync.) 
      </p>
        <p>
        Add new tasks by tapping 
                  <span style="margin-left:6px; position:relative; top:-3px; text-align:center; width:28px; height:28px; background:#159957; background:#4384F6" class="btn-floating waves-effect waves-light" aria-hidden="true">
            <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 212 212" style="width:100%; height:100%; enable-background:new 0 0 212 212;" xml:space="preserve">
              <style type="text/css">
	.st0{fill:#FFFFFF;}
              </style>
              <rect x="102.7" y="75" class="st0" width="6.7" height="62"></rect>
              <rect x="102.7" y="75" transform="matrix(-1.836970e-16 1 -1 -1.836970e-16 212 1.421085e-14)" class="st0" width="6.7" height="62"></rect>
            </svg>
          </span>
        </p>
        <p>
        Name or edit your tasks by tapping inside them. 
      </p>
        <p>To remove an unwanted task tap           <i class="fa fa-times" aria-hidden="true" style="position:relative; top:3px; font-size:27px; color:#bbb;"></i>
        </p>
        <p>To start a task tap                           
                <i class="fa fa-calendar-o" style="position:relative; left:0px; top:3px; margin-left:2px; font-size:23px; color:#bbb;" aria-hidden="true"></i>
        </p>
        <p>
        To finish a task and record it as an event in Google Calendar, tap again           <i class="fa fa-calendar-check-o finish" style="position:relative; left:0px; top:3px; margin-left:2px; font-size:23px; padding:3px; padding-right:1px; padding-top:2px; color:#bbb; color:white;" aria-hidden="true"></i>
        </p>
        <h3>Calendar Suggestions</h3>
        <table>
          <tbody>
            <tr>
              <td>SLEEP  -</td>
              <td>Start a task each night and complete it when you wake up. Use it to see your sleeping pattern throughout the week.</td>
            </tr>
          </tbody>
        </table>
        <table>
          <tbody>
            <tr>
              <td>FOOD  -</td>
              <td>Start a task and complete it everytime you eat something. Use it as a food journal for dieting.</td>
            </tr>
          </tbody>
        </table>
        <table>
          <tbody>
            <tr>
              <td>WORKOUT  -</td>
              <td>Start a task when you begin your workout and complete it when you finish. Use it as a fitness journal.</td>
            </tr>
          </tbody>
        </table>
        <table>
          <tbody>
            <tr>
              <td>OTHER  -</td>
              <td>Use this task list for tasks or events that wouldn't logically fit in another category.</td>
            </tr>
          </tbody>r
        </table>
        <table>
          <tbody>
            <tr>
              <td>SCHEDULE  -</td>
              <td>
                <b>Don't add tasks to this calendar.</b>
 Instead, schedule your day with it in Google Calendars, then use other calendars to complete your tasks. At the end of the day compare what you scheduled with the tasks you completed.</td>
            </tr>
          </tbody>
        </table>
        <h3>Save to homescreen</h3>
        <p>This is a web app, which means you can save it to your phone and use it like an app. To learn how click           <a href="http://lifehacker.com/5809338/add-web-site-bookmarks-to-your-iphones-homescreen">here for iPhone</a>
 and           <a href="http://www.howtogeek.com/196087/how-to-add-websites-to-the-home-screen-on-any-smartphone-or-tablet/">here for Android</a>
.</p>
        <h3>Hide instructions</h3>
        <p style="position:relative;">
        Tap           <i onclick="hideInstructions();" style="font-size:37px; color:#4384F6; position:absolute; top:-10px; left:30px;" class="fa fa-caret-up" aria-hidden="true"></i>
        </p>
      </div>
      
      <!--<pre id="output"></pre>-->
      <!--       <div class="site-footer"></div> -->
      
      
                      <div  style="margin-bottom:15px;" >
                      <h3 style="color:white; background:#4384F6; padding:10px; padding-left:25px; padding-right:10px; padding-bottom:5px; position:relative; left:-25px; border-top-right-radius:25px; border-bottom-right-radius:25px; ">
                      <span onclick="hideAllTasks()" style="position:relative; top:-3px; text-align:center; width:28px; height:28px; background:#159957; background:#4384F6; background:white;" class="btn-floating waves-effect waves-dark" aria-hidden="true">      
                      <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                      	 viewBox="0 0 212 212" style="width:100%; height:100%; enable-background:new 0 0 212 212;" xml:space="preserve">
                      <rect x="102.7" y="75" style="fill:#4384F6" transform="matrix(-1.836970e-16 1 -1 -1.836970e-16 212 1.421085e-14)"  width="6.7" height="62"/>
                      </svg>
                      </span>
                      <span onclick="showAllTasks()" style="position:relative; top:-3px; text-align:center; width:28px; height:28px; background:#159957; background:#4384F6; background:white;"  class="btn-floating waves-effect waves-dark" aria-hidden="true">      
                      <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                      	 viewBox="0 0 212 212" style="width:100%; height:100%; enable-background:new 0 0 212 212;" xml:space="preserve">
                      <rect x="102.7" y="75" style="fill:#4384F6" width="6.7" height="62"/>
                      <rect x="102.7" y="75" style="fill:#4384F6" transform="matrix(-1.836970e-16 1 -1 -1.836970e-16 212 1.421085e-14)"  width="6.7" height="62"/>
                      </svg>
                      </span></h3></div>
      
      <div id="tasks" style="min-height:400px;"></div>
      <div id="showInstructions" style="display:none; margin-bottom:20px; text-align:center;">
        <p style="position:relative;">
          Show instructions <i onclick="showInstructions();" style="font-size:37px; color:#4384F6; position:relative; top:5px; margin:auto;" class="fa fa-caret-up" aria-hidden="true"></i>
        </p>
      </div>
      <div style="text-align:center;">
        <div class="switch">
          Default colors <br/>
        <label>
          Off
          <input type="checkbox" id="defaultColors" onclick="TASKAPI.toggleColors(this.checked)">
          <span class="lever"></span>
          On
        </label>
      </div>
      </div>
      <footer class="site-footer" id="ads" style="margin-top:1000px;">
        <script async="" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <!-- CalendarTasks Display -->
        <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-0041371254736366" data-ad-slot="9796510276" data-ad-format="auto"></ins>
        <script>
(adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      </footer>
    </section>
    <section id="theCalendars"></section>
    
  </body>

</html>
